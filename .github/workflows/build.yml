name: Android Build Test

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ðŸ”§ è‡ªåŠ¨è®¾ç½® Gradle Wrapper
      run: |
        echo "å®‰è£… Gradle Wrapper..."
        gradle wrapper --gradle-version 7.5
        ls -la
        ls -la gradle/wrapper/ || true
        chmod +x gradlew
        ./gradlew --version
    
    - name: ðŸ“¦ ä¸‹è½½ä¾èµ–ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
      continue-on-error: true
      run: |
        echo "========================================" | tee dependencies.log
        echo "å¼€å§‹ä¸‹è½½é¡¹ç›®ä¾èµ–" | tee -a dependencies.log
        echo "========================================" | tee -a dependencies.log
        ./gradlew dependencies --info --stacktrace 2>&1 | tee -a dependencies.log
    
    - name: ðŸ—ï¸ æ‰§è¡Œå®Œæ•´æž„å»ºï¼ˆè¶…è¯¦ç»†æ¨¡å¼ï¼‰
      continue-on-error: true
      run: |
        echo "========================================" | tee full_build.log
        echo "Android çœŸå®žæž„å»ºå¼€å§‹" | tee -a full_build.log
        echo "æ—¶é—´: $(date)" | tee -a full_build.log
        echo "========================================" | tee -a full_build.log
        echo "" | tee -a full_build.log
        
        # ä½¿ç”¨ --info èŽ·å–è¯¦ç»†æ—¥å¿—ï¼Œ--stacktrace èŽ·å–å®Œæ•´å †æ ˆ
        ./gradlew clean assembleDebug --info --stacktrace 2>&1 | tee -a full_build.log
        
        echo "" | tee -a full_build.log
        echo "========================================" | tee -a full_build.log
        echo "æž„å»ºç»“æŸ" | tee -a full_build.log
        echo "é€€å‡ºç : $?" | tee -a full_build.log
        echo "========================================" | tee -a full_build.log
    
    - name: ðŸ“Š æ”¶é›†æž„å»ºä¿¡æ¯
      if: always()
      run: |
        echo "========================================" | tee build_info.log
        echo "æž„å»ºçŽ¯å¢ƒä¿¡æ¯" | tee -a build_info.log
        echo "========================================" | tee -a build_info.log
        echo "Gradle ç‰ˆæœ¬:" | tee -a build_info.log
        ./gradlew --version 2>&1 | tee -a build_info.log
        echo "" | tee -a build_info.log
        echo "Java ç‰ˆæœ¬:" | tee -a build_info.log
        java -version 2>&1 | tee -a build_info.log
        echo "" | tee -a build_info.log
        echo "Android SDK ä¿¡æ¯:" | tee -a build_info.log
        ls -la $ANDROID_HOME 2>&1 | tee -a build_info.log || echo "SDK è·¯å¾„æœªè®¾ç½®" | tee -a build_info.log
    
    - name: ðŸ“‹ æ±‡æ€»è¶…è¯¦ç»†æ—¥å¿—
      if: always()
      run: |
        echo "========================================" > detailed_build_log.txt
        echo "Android çœŸå®žæž„å»ºå¤±è´¥ - å®Œæ•´æ—¥å¿—" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        echo "ðŸ“¦ ä»“åº“: ${{ github.repository }}" >> detailed_build_log.txt
        echo "ðŸ”– æäº¤: ${{ github.sha }}" >> detailed_build_log.txt
        echo "â° æ—¶é—´: $(date)" >> detailed_build_log.txt
        echo "ðŸ’» è¿è¡Œå™¨: ${{ runner.os }}" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        
        echo "========================================" >> detailed_build_log.txt
        echo "ðŸ“Š æž„å»ºçŽ¯å¢ƒä¿¡æ¯" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        cat build_info.log >> detailed_build_log.txt 2>/dev/null || echo "æ— çŽ¯å¢ƒä¿¡æ¯" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        
        echo "========================================" >> detailed_build_log.txt
        echo "ðŸ“¦ ä¾èµ–ä¸‹è½½æ—¥å¿—ï¼ˆåŒ…å«æ‰€æœ‰åº“ï¼‰" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        cat dependencies.log >> detailed_build_log.txt 2>/dev/null || echo "æ— ä¾èµ–æ—¥å¿—" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        
        echo "========================================" >> detailed_build_log.txt
        echo "ðŸ—ï¸ å®Œæ•´æž„å»ºæ—¥å¿—ï¼ˆåŒ…å«æ‰€æœ‰Taskï¼‰" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        cat full_build.log >> detailed_build_log.txt 2>/dev/null || echo "æ— æž„å»ºæ—¥å¿—" >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        
        echo "========================================" >> detailed_build_log.txt
        echo "ðŸ“ é¡¹ç›®æ–‡ä»¶ç»“æž„" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        find . -type f \KATEX_INLINE_OPEN -name "*.java" -o -name "*.gradle" -o -name "*.xml" -o -name "*.properties" \KATEX_INLINE_CLOSE | grep -v ".gradle/" | sort >> detailed_build_log.txt
        echo "" >> detailed_build_log.txt
        
        echo "========================================" >> detailed_build_log.txt
        echo "ðŸ“ˆ æ—¥å¿—ç»Ÿè®¡" >> detailed_build_log.txt
        echo "========================================" >> detailed_build_log.txt
        echo "æ€»è¡Œæ•°: $(wc -l detailed_build_log.txt | awk '{print $1}')" >> detailed_build_log.txt
        echo "æ–‡ä»¶å¤§å°: $(du -h detailed_build_log.txt | awk '{print $1}')" >> detailed_build_log.txt
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> detailed_build_log.txt
        
    - name: ðŸ“¤ ä¸Šä¼ å®Œæ•´æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: complete-build-logs
        path: |
          detailed_build_log.txt
          full_build.log
          dependencies.log
          build_info.log
        retention-days: 7
